<!DOCTYPE html>
<html>
<head>
    <title>Token Creator</title>
    <style>
        body { font-family: Arial; max-width: 400px; margin: 50px auto; padding: 20px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Create Token</h1>
    
    <button id="connect">Connect Phantom</button>
    <div id="wallet"></div>
    
    <div id="form" style="display:none;">
        <input id="name" placeholder="Token Name">
        <input id="symbol" placeholder="Symbol">
        <input id="supply" type="number" placeholder="Supply" value="1000">
        <button id="create">Create Token</button>
    </div>
    
    <div id="status"></div>
    <div id="result"></div>

    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    <script type="module">
        try {
            const splToken = await import('https://esm.sh/@solana/spl-token@0.3.8');
            window.splToken = splToken;
            
            // Import Metaplex for metadata
            const mpl = await import('https://esm.sh/@metaplex-foundation/mpl-token-metadata@2.13.0');
            window.mpl = mpl;
        } catch (error) {
            console.error('Failed to load libraries:', error);
        }
    </script>
    <script>
        setTimeout(() => {
            const connection = new solanaWeb3.Connection('https://solana-mainnet.g.alchemy.com/v2/ALCHEMY-KEY', 'confirmed');
            let wallet = null;

            document.getElementById('connect').onclick = async () => {
                try {
                    if (!window.solana) {
                        alert('Phantom wallet not found! Please install Phantom browser extension.');
                        return;
                    }
                    
                    const response = await window.solana.connect();
                    wallet = window.solana;
                    
                    console.log('Wallet connected:', response.publicKey.toString());
                    document.getElementById('wallet').innerHTML = `Connected: ${response.publicKey.toString().slice(0, 8)}...`;
                    document.getElementById('form').style.display = 'block';
                    document.getElementById('connect').style.display = 'none';
                    
                } catch (error) {
                    console.error('Connection failed:', error);
                    alert('Failed to connect: ' + error.message);
                }
            };

            document.getElementById('create').onclick = async () => {
                const name = document.getElementById('name').value;
                const symbol = document.getElementById('symbol').value;
                const supply = parseInt(document.getElementById('supply').value);
                
                if (!name || !symbol || !supply) return showStatus('Fill all fields', 'error');

                showStatus('Creating token...', '');
                document.getElementById('create').disabled = true;

                try {
                    console.log('Creating token...');
                    
                    // Generate a new keypair for the mint
                    const mintKeypair = solanaWeb3.Keypair.generate();
                    
                    // Calculate rent for mint account
                    const mintRent = await connection.getMinimumBalanceForRentExemption(82);
                    
                    // Create mint account instruction
                    const createMintAccountIx = solanaWeb3.SystemProgram.createAccount({
                        fromPubkey: wallet.publicKey,
                        newAccountPubkey: mintKeypair.publicKey,
                        lamports: mintRent,
                        space: 82,
                        programId: window.splToken.TOKEN_PROGRAM_ID
                    });
                    
                    // Initialize mint instruction (identity)
                    const initializeMintIx = window.splToken.createInitializeMintInstruction(
                        mintKeypair.publicKey,
                        9, // decimals
                        wallet.publicKey, // mint authority
                        null, // freeze authority
                        window.splToken.TOKEN_PROGRAM_ID
                    );
                    
                    const mint = mintKeypair.publicKey;
                    console.log('Preparing to create token:', mint.toBase58());
                    
                    // Prepare metadata instruction
                    console.log('Preparing metadata...');
                    const TOKEN_METADATA_PROGRAM_ID = new solanaWeb3.PublicKey('metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s');
                    
                    // Find metadata PDA (program derived address)
                    const [metadataPDA] = solanaWeb3.PublicKey.findProgramAddressSync(
                        [
                            Buffer.from('metadata'),
                            TOKEN_METADATA_PROGRAM_ID.toBuffer(),
                            mint.toBuffer()
                        ],
                        TOKEN_METADATA_PROGRAM_ID
                    );
                    
                    // Create metadata instruction
                    const accounts = {
                        metadata: metadataPDA,
                        mint: mint,
                        mintAuthority: wallet.publicKey,
                        payer: wallet.publicKey,
                        updateAuthority: wallet.publicKey,
                        systemProgram: solanaWeb3.SystemProgram.programId,
                        rent: solanaWeb3.SYSVAR_RENT_PUBKEY,
                    };
                    
                    const args = {
                        createMetadataAccountArgsV3: {
                            data: {
                                name: name,
                                symbol: symbol,
                                uri: '',
                                sellerFeeBasisPoints: 0,
                                creators: null,
                                collection: null,
                                uses: null,
                            },
                            isMutable: true,
                            collectionDetails: null,
                        },
                    };
                    
                    const createMetadataInstruction = window.mpl.createCreateMetadataAccountV3Instruction(
                        accounts,
                        args
                    );
                    
                    try {
                        // Get the associated token address         
                        const associatedTokenAddress = await window.splToken.getAssociatedTokenAddress(
                            mint,
                            wallet.publicKey
                        );
                        
                        // Create the associated token account instruction
                        const createATAInstruction = window.splToken.createAssociatedTokenAccountInstruction(
                            wallet.publicKey, // payer
                            associatedTokenAddress, // ata
                            wallet.publicKey, // owner
                            mint // mint
                        );
                        
                        // Create mint instruction
                        const mintInstruction = window.splToken.createMintToInstruction(
                            mint, // mint
                            associatedTokenAddress, // destination
                            wallet.publicKey, // authority
                            supply * Math.pow(10, 9) // amount
                        );
                        
                        // Combine ALL instructions in a single transaction
                        console.log('Creating token in a single transaction...');
                        const singleTx = new solanaWeb3.Transaction()
                            .add(createMintAccountIx)        // 1. Create mint account
                            .add(initializeMintIx)           // 2. Initialize mint
                            .add(createMetadataInstruction)  // 3. Add metadata
                            .add(createATAInstruction)       // 4. Create token account
                            .add(mintInstruction);           // 5. Mint initial supply
                        
                        singleTx.feePayer = wallet.publicKey;
                        const { blockhash } = await connection.getLatestBlockhash('confirmed');
                        singleTx.recentBlockhash = blockhash;
                        
                        // Need to partially sign with mint keypair first
                        singleTx.partialSign(mintKeypair);
                        
                        // Then sign with wallet
                        const signedTx = await wallet.signTransaction(singleTx);
                        const signature = await connection.sendRawTransaction(signedTx.serialize());
                        
                        console.log('Transaction sent:', signature);
                        await new Promise(resolve => setTimeout(resolve, 5000));
                        console.log('Token created');
                        
                        document.getElementById('result').innerHTML = `
                            <div class="status success">
                                <h3>Token created successfully!</h3>
                                <p><strong>Name:</strong> ${name}</p>
                                <p><strong>Symbol:</strong> ${symbol}</p>
                                <p><strong>Supply:</strong> ${supply.toLocaleString()}</p>
                                <p><strong>Mint:</strong> ${mint.toBase58()}</p>
                                <p><strong>Token Account:</strong> ${associatedTokenAddress.toBase58()}</p>
                                <a href="https://explorer.solana.com/address/${mint.toBase58()}" target="_blank">
                                    View Token on Explorer
                                </a>
                            </div>
                        `;
                        
                    } catch (tokenError) {
                        console.error('Token account/minting error:', tokenError);
                    }
                    
                    showStatus('', '');

                } catch (error) {
                    console.error('Error:', error);
                    showStatus('Error: ' + error.message, 'error');
                }
                
                document.getElementById('create').disabled = false;
            };

            function showStatus(msg, type) {
                document.getElementById('status').innerHTML = msg ? `<div class="status ${type}">${msg}</div>` : '';
            }
        }, 3000); 
    </script>
</body>
</html>